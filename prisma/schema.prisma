datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Rol {
  SUPERADMIN
  ADMIN_COLEGIO
  CONDUCTOR
  PADRE
}

model Colegio {
  id           Int          @id @default(autoincrement())
  nombre       String       @unique
  direccion    String?
  lat          Float?
  lon          Float?
  activo       Boolean      @default(true)

  // relaciones
  usuarios     Usuario[]    @relation("ColegioUsuarios")
  estudiantes  Estudiante[]
  buses        Bus[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([activo])
}

model Usuario {
  id            Int       @id @default(autoincrement())
  rol           Rol
  email         String    @unique
  hashPassword  String
  nombre        String
  telefono      String?
  activo        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // N:M con estudiantes (padre ↔ hijos)
  hijos         PadreEstudiante[]

  // Si es ADMIN_COLEGIO o CONDUCTOR puede pertenecer a un colegio; PADRE/SUPERADMIN normalmente null
  colegioId     Int?
  colegio       Colegio?   @relation("ColegioUsuarios", fields: [colegioId], references: [id], onDelete: SetNull)

  // si es conductor puede tener buses asignados
  busesConductor Bus[]

  @@index([rol, activo])
}

model Estudiante {
  id         Int       @id @default(autoincrement())
  colegioId  Int
  colegio    Colegio   @relation(fields: [colegioId], references: [id], onDelete: Cascade)

  codigo     String
  ci         String?
  nombre     String
  curso      String?
  activo     Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now())

  padres         PadreEstudiante[]
  buses          EstudianteBus[]

  @@unique([colegioId, codigo])   // único por colegio
  @@index([colegioId, activo])
}

model PadreEstudiante {
  padreId       Int
  estudianteId  Int

  padre         Usuario    @relation(fields: [padreId], references: [id], onDelete: Cascade)
  estudiante    Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)

  createdAt     DateTime   @default(now())

  @@id([padreId, estudianteId])
}

model Bus {
  id          Int       @id @default(autoincrement())
  colegioId   Int
  codigo      String    // identificador único del bus dentro del colegio
  nombre      String?   // nombre de la ruta o descripción
  placa       String?   // placa del bus
  conductorId Int?      // usuario con rol CONDUCTOR
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())

  colegio     Colegio   @relation(fields: [colegioId], references: [id], onDelete: Cascade)
  conductor   Usuario?  @relation(fields: [conductorId], references: [id], onDelete: SetNull)
  estudiantes EstudianteBus[]

  @@unique([colegioId, codigo])
  @@index([colegioId, activo])
}

model EstudianteBus {
  estudianteId Int
  busId        Int

  estudiante   Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  bus          Bus        @relation(fields: [busId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())

  @@id([estudianteId, busId])
}
